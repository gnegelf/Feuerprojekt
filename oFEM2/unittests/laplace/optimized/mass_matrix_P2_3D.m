function [M,t]=mass_matrix_P2_3D(co,el)
% mass_matrix_P2_3D is the 3D P2 mass matrix, i.e.
% it returns the matrix associated with
% $$
% \int_{T_s} \varphi_i(x) \varphi_j(x)\,dx,
% $$
% with $T_s$ the s-th element and $i,j$ the indices of the nodes.
%
% [M,t]=mass_matrix_P1_2D(co,el)
% M is the mass matrix, t the time duration for computing M,
% co are the coordinates, el the elements
%

tic

% read number of coordinates and elements
nC = numel(co(:,1));
% edges
e12 = co(el(:,2),:) - co(el(:,1),:);
e13 = co(el(:,3),:) - co(el(:,1),:);
e14 = co(el(:,4),:) - co(el(:,1),:);
% det
detD = dot(e12,cross(e13,e14,2),2)';

idx=tril(ones(10,10))==1;
II=repmat(1:10,10,1);
J = el(:,II(idx))';
II=II';
I = el(:,II(idx))';
% I = el(:,[1:10,2:10,3:10,3:10,4:10,5:10,6:10,7:10,8:10,9:10,10])';
% J = el(:,[ones(1,10),2*ones(1,9),3*ones(1,8),4*ones(1,7),5*ones(1,6),6*ones(1,5),7*ones(1,4),8*ones(1,3),9*ones(1,2),10])';

M = [ 1/480, -1/2520, -1/2520, -1/2520, -1/630, -1/630, -1/630, -1/420, -1/420, -1/420, ...
      1/480, -1/2520, -1/2520, -1/630 , -1/420, -1/420, -1/630, -1/630, -1/420, ...
      1/480, -1/2520, -1/420 , -1/630 , -1/420, -1/630, -1/420, -1/630, ...
      1/480, -1/420 , -1/420 , -1/630 , -1/420, -1/630, -1/630, ...
      4/315,  2/315 ,  2/315 ,  2/315 ,  2/315,  1/315, ...
      4/315,  2/315 ,  2/315 ,  1/315 ,  2/315, ...
      4/315,  1/315 ,  2/315 ,  2/315 , ...
      4/315,  2/315 ,  2/315 , ...
      4/315,  2/315 , ...
      4/315]'*detD;

M = sparse(I(:),J(:),M(:),nC,nC);
M = M+M'-diag(diag(M));


% I = el(:,repmat(1:10,1,10))';
% J = el(:,repmat(1:10,10,1))';
% 
% M = [ 1/480 ; -1/2520; -1/2520; -1/2520; -1/630; -1/630; -1/630; -1/420; -1/420; -1/420; ...
%      -1/2520;  1/480 ; -1/2520; -1/2520; -1/630; -1/420; -1/420; -1/630; -1/630; -1/420; ...
%      -1/2520; -1/2520;  1/480 ; -1/2520; -1/420; -1/630; -1/420; -1/630; -1/420; -1/630; ...
%      -1/2520; -1/2520; -1/2520;  1/480 ; -1/420; -1/420; -1/630; -1/420; -1/630; -1/630; ...
%      -1/630 ; -1/630 ; -1/420 ; -1/420 ;  4/315;  2/315;  2/315;  2/315;  2/315;  1/315; ...
%      -1/630 ; -1/420 ; -1/630 ; -1/420 ;  2/315;  4/315;  2/315;  2/315;  1/315;  2/315; ...
%      -1/630 ; -1/420 ; -1/420 ; -1/630 ;  2/315;  2/315;  4/315;  1/315;  2/315;  2/315; ...
%      -1/420 ; -1/630 ; -1/630 ; -1/420 ;  2/315;  2/315;  1/315;  4/315;  2/315;  2/315; ...
%      -1/420 ; -1/630 ; -1/420 ; -1/630 ;  2/315;  1/315;  2/315;  2/315;  4/315;  2/315; ...
%      -1/420 ; -1/420 ; -1/630 ; -1/630 ;  1/315;  2/315;  2/315;  2/315;  2/315;  4/315 ]*detD;
% 
% M = sparse(I(:),J(:),M(:),nC,nC);

t=toc;

end
